<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Analítica | DataConecta</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Carga de Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- NUEVO: Carga de Heatmap.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.2/heatmap.min.js"></script>
    
    <!-- NUEVO: Carga de Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2c3e50;
            --accent: #9b59b6;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --text: #333;
            --text-light: #7f8c8d;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --bg-light: #f9fbfd;
            --bg-darker: #f1f5f9;
            --border-color: #e2e8f0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--bg-light);
            color: var(--text);
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header (Consistente con los otros archivos) */
        header {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--dark) 100%);
            color: white;
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: 700;
        }
        
        .logo i {
            margin-right: 10px;
            color: var(--primary);
        }
        
        .nav-menu {
            display: flex;
            align-items: center;
            list-style: none;
        }
        
        .nav-menu li {
            margin-left: 20px;
        }
        
        .nav-menu a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 5px 8px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .nav-menu a:hover {
            color: var(--primary);
        }
        
        .nav-menu a.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 700;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }

        /* Layout del Dashboard de Analítica */
        .analytics-main {
            padding: 40px 0;
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-light);
        }
        
        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        
        .card-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .card-change {
            font-size: 14px;
        }
        .card-change.positive {
            color: var(--success);
        }
        .card-change.negative {
            color: var(--danger);
        }

        /* Tabs de Analítica */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .chart-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Estilos para Mapas de Calor */
        .heatmap-controls {
            background-color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .form-group {
            margin-bottom: 0;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        .heatmap-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .heatmap-screenshot {
            display: block;
            width: 100%;
            height: auto;
            /* AHORA: Opacidad total, heatmap.js se superpone */
            opacity: 1; 
        }
        
        /* El canvas de heatmap.js se posicionará absolutamente */
        .heatmap-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.6;
        }

        /* Estilos para Grabación de Sesiones */
        .table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: auto;
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--text-light);
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: #333;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: white;
        }
        
        .close {
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
            font-weight: 700;
        }
        .close:hover {
            color: white;
        }

        .session-player-body {
            position: relative;
            width: 100%;
            height: 450px;
            background-color: var(--bg-darker);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .session-player-body .fake-browser-ui {
            background: #ddd;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .session-player-body .dot {
            width: 12px; height: 12px; border-radius: 50%; background: #bbb;
        }
        .session-player-body .address-bar {
            flex: 1; height: 20px; background: white; border-radius: 4px;
        }

        .fake-cursor {
            position: absolute;
            font-size: 24px;
            color: var(--primary);
            transform: rotate(-45deg);
            animation: moveCursor 15s infinite ease-in-out;
            will-change: top, left;
        }
        
        @keyframes moveCursor {
            0% { top: 50px; left: 50px; }
            10% { top: 80px; left: 300px; }
            20% { top: 150px; left: 200px; }
            30% { top: 160px; left: 210px; } /* Simula clic */
            31% { top: 160px; left: 210px; opacity: 0.5; }
            32% { top: 160px; left: 210px; opacity: 1; }
            40% { top: 300px; left: 100px; } /* Scroll */
            50% { top: 100px; left: 400px; }
            60% { top: 250px; left: 500px; }
            70% { top: 350px; left: 300px; }
            80% { top: 360px; left: 310px; } /* Simula clic */
            81% { top: 360px; left: 310px; opacity: 0.5; }
            82% { top: 360px; left: 310px; opacity: 1; }
            90% { top: 80px; left: 150px; }
            100% { top: 50px; left: 50px; }
        }

        /* Estilos para Embudo de Conversión */
        .funnel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: white;
            padding: 30px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .funnel-step {
            width: 100%;
            max-width: 500px;
            background-color: var(--primary);
            color: white;
            padding: 15px 20px;
            text-align: center;
            border-radius: 4px;
            margin-bottom: 10px; /* Espacio para el conector */
            position: relative;
            transition: all 0.3s;
        }
        
        .funnel-step:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -15px; /* Mitad del espacio */
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 15px solid var(--primary); /* Color del step */
        }
        
        .funnel-step-name {
            font-weight: 600;
            font-size: 16px;
        }
        .funnel-step-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .funnel-step-rate {
            font-size: 14px;
            opacity: 0.8;
        }
        .funnel-step-dropoff {
            font-size: 12px;
            color: var(--danger);
            background-color: white;
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 5px;
            font-weight: 600;
        }

        /* Ancho de los steps */
        .funnel-step[data-step="1"] { width: 100%; max-width: 500px; }
        .funnel-step[data-step="2"] { width: 80%; max-width: 400px; background-color: #4ea8de; }
        .funnel-step[data-step="2"]::after { border-top-color: #4ea8de; }
        .funnel-step[data-step="3"] { width: 50%; max-width: 250px; background-color: #6bb9e3; }
        .funnel-step[data-step="3"]::after { border-top-color: #6bb9e3; }
        .funnel-step[data-step="4"] { width: 30%; max-width: 150px; background-color: #87c9e9; }
        

        /* Puntos de Fricción */
        .friction-list .friction-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .friction-list .friction-item:last-child {
            border-bottom: none;
        }
        .friction-icon {
            font-size: 20px;
            color: var(--danger);
            margin-right: 15px;
        }
        .friction-desc {
            flex: 1;
        }
        .friction-desc strong {
            color: var(--dark);
        }
        .friction-desc span {
            font-size: 14px;
            color: var(--text-light);
            display: block;
        }
        
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-container">
            <div class="logo">
                <i class="fas fa-chart-pie"></i>
                <span>DataConecta</span>
            </div>
            <!-- NAVEGACIÓN -->
            <ul class="nav-menu">
                <li><a href="./index.html">CRM</a></li>
                <li><a href="./editor.html">Editor</a></li>
                <li><a href="./analitica.html" class="active">Analítica</a></li>
            </ul>
            <!-- NUEVO BOTÓN DE SIMULACIÓN -->
            <button class="btn btn-primary" id="simulate-traffic-btn" style="margin-left: 20px;">
                <i class="fas fa-sync-alt"></i> Simular Tráfico
            </button>
        </div>
    </header>

    <!-- Dashboard de Analítica -->
    <main class="analytics-main">
        <div class="container">
            
            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" data-tab="dashboard">Dashboard</div>
                <div class="tab" data-tab="heatmaps">Mapas de Calor</div>
                <div class="tab" data-tab="recordings">Grabaciones</div>
                <div class="tab" data-tab="funnels">Embudos</div>
            </div>

            <!-- Contenido Pestaña: Dashboard -->
            <div class="tab-content active" id="dashboard-content">
                <!-- Métricas Clave -->
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Total Visitas</div>
                            <div class="card-icon" style="background-color: var(--primary);"><i class="fas fa-eye"></i></div>
                        </div>
                        <div class="card-value" id="kpi-visits">Cargando...</div>
                        <div class="card-change" id="kpi-visits-change"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Conversiones</div>
                            <div class="card-icon" style="background-color: var(--success);"><i class="fas fa-bullseye"></i></div>
                        </div>
                        <div class="card-value" id="kpi-conversions">Cargando...</div>
                        <div class="card-change" id="kpi-conversions-change"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Tasa de Abandono</div>
                            <div class="card-icon" style="background-color: var(--warning);"><i class="fas fa-sign-out-alt"></i></div>
                        </div>
                        <div class="card-value" id="kpi-bounce">Cargando...</div>
                        <div class="card-change" id="kpi-bounce-change"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Engagement</div>
                            <div class="card-icon" style="background-color: var(--accent);"><i class="fas fa-hand-pointer"></i></div>
                        </div>
                        <div class="card-value" id="kpi-engagement">Cargando...</div>
                        <div class="card-change" id="kpi-engagement-change"></div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="chart-container">
                    <canvas id="visitsChart"></canvas>
                </div>
                
                <div class="dashboard-cards">
                    <div class="chart-container">
                         <canvas id="trafficSourceChart"></canvas>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Puntos de Fricción Detectados</div>
                        </div>
                        <div class="friction-list">
                            <div class="friction-item">
                                <div class="friction-icon"><i class="fas fa-mouse"></i></div>
                                <div class="friction-desc">
                                    <strong>Rage Clicks</strong>
                                    <span>Detectados 84 clics rápidos en el botón "Comprar" en la página de precios.</span>
                                </div>
                            </div>
                            <div class="friction-item">
                                <div class="friction-icon"><i class="fas fa-redo-alt"></i></div>
                                <div class="friction-desc">
                                    <strong>Recargas Excesivas</strong>
                                    <span>Usuarios recargan la página de checkout un promedio de 3.4 veces.</span>
                                </div>
                            </div>
                            <div class="friction-item">
                                <div class="friction-icon"><i class="fas fa-clock"></i></div>
                                <div class="friction-desc">
                                    <strong>Tiempo Excesivo</strong>
                                    <span>Los usuarios tardan un promedio de 98s en el formulario de registro.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido Pestaña: Mapas de Calor -->
            <div class="tab-content" id="heatmaps-content">
                <div class="heatmap-controls">
                    <div class="form-group">
                        <label class="form-label" for="heatmap-page">Seleccionar Página</label>
                        <select class="form-control" id="heatmap-page">
                            <option value="homepage">Homepage</option>
                            <option value="pricing">Página de Precios</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="heatmap-type">Tipo de Mapa</label>
                        <select class="form-control" id="heatmap-type">
                            <option value="click">Mapa de Clics</option>
                            <option value="move">Mapa de Movimiento</option>
                            <option value="scroll">Mapa de Scroll</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="generate-heatmap" style="margin-top: 23px;">Generar</button>
                </div>

                <div class="heatmap-container" id="heatmap-container">
                    <!-- Imagen de fondo (simulada) -->
                    <img src="https://placehold.co/1200x1800/f1f5f9/ccc?text=Captura+de+Pagina+Simulada" 
                         alt="Captura de página simulada" 
                         class="heatmap-screenshot"
                         id="heatmap-screenshot-img">
                    
                    <!-- heatmap.js inyectará su propio canvas aquí -->
                </div>
            </div>

            <!-- Contenido Pestaña: Grabaciones -->
            <div class="tab-content" id="recordings-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Fecha</th>
                                <th>Duración</th>
                                <th>Páginas Vistas</th>
                                <th>Dispositivo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="sessions-tbody">
                            <!-- Datos de ejemplo -->
                            <tr>
                                <td>Usuario #4821</td>
                                <td>07/11/2025 14:30</td>
                                <td>3 min 12s</td>
                                <td>5</td>
                                <td><i class="fas fa-desktop"></i> Escritorio</td>
                                <td><button class="btn btn-outline play-session">Reproducir</button></td>
                            </tr>
                            <tr>
                                <td>Usuario #4822</td>
                                <td>07/11/2025 14:28</td>
                                <td>1 min 45s</td>
                                <td>3</td>
                                <td><i class="fas fa-mobile-alt"></i> Móvil</td>
                                <td><button class="btn btn-outline play-session">Reproducir</button></td>
                            </tr>
                            <tr>
                                <td>Usuario #4823</td>
                                <td>07/11/2025 14:25</td>
                                <td>5 min 02s</td>
                                <td>8</td>
                                <td><i class="fas fa-tablet-alt"></i> Tablet</td>
                                <td><button class="btn btn-outline play-session">Reproducir</button></td>
                            </tr>
                            <tr>
                                <td>Usuario #4824</td>
                                <td>07/11/2025 14:19</td>
                                <td>0 min 31s</td>
                                <td>2</td>
                                <td><i class="fas fa-desktop"></i> Escritorio</td>
                                <td><button class="btn btn-outline play-session">Reproducir</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Contenido Pestaña: Embudos -->
            <div class="tab-content" id="funnels-content">
                <div class="funnel-container">
                    <div class="funnel-step" data-step="1">
                        <div class="funnel-step-name">1. Visita a Homepage</div>
                        <div class="funnel-step-value">14,830 Usuarios</div>
                        <div class="funnel-step-rate">100%</div>
                    </div>
                    <div class="funnel-step" data-step="2">
                        <div class="funnel-step-name">2. Visita a Precios</div>
                        <div class="funnel-step-value">11,864 Usuarios</div>
                        <div class="funnel-step-rate">80% de conversión</div>
                        <div class="funnel-step-dropoff">20% abandono</div>
                    </div>
                    <div class="funnel-step" data-step="3">
                        <div class="funnel-step-name">3. Inicia Checkout</div>
                        <div class="funnel-step-value">5,932 Usuarios</div>
                        <div class="funnel-step-rate">50% de conversión</div>
                        <div class="funnel-step-dropoff">50% abandono</div>
                    </div>
                    <div class="funnel-step" data-step="4">
                        <div class="funnel-step-name">4. Compra Realizada</div>
                        <div class="funnel-step-value">712 Usuarios</div>
                        <div class="funnel-step-rate">12% de conversión</div>
                        <div class="funnel-step-dropoff">88% abandono</div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Modal de Reproducción de Sesión -->
    <div class="modal" id="session-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Reproduciendo Sesión - Usuario #4821</h3>
                <span class="close" id="close-session-modal">&times;</span>
            </div>
            <div class="session-player-body">
                <!-- UI Falsa de Navegador -->
                <div class="fake-browser-ui">
                    <div class="dot" style="background: #ed594a;"></div>
                    <div class="dot" style="background: #fdd800;"></div>
                    <div class="dot" style="background: #5ac05a;"></div>
                    <div class="address-bar"></div>
                </div>
                <!-- Cursor Falso Animado -->
                <i class="fas fa-mouse-pointer fake-cursor"></i>
            </div>
        </div>
    </div>


    <script type="module">
        // --- 0. INICIALIZACIÓN DE FIREBASE ---
        let db, auth, userId, appId, kpisDocRef;
        
        // Importar funciones de los SDKs (versión 9 modular)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        async function initFirebase() {
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-analytics-app';
            const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            
            if (!firebaseConfigStr || firebaseConfigStr === '{}') {
                console.error("Configuración de Firebase no encontrada. El dashboard en tiempo real no funcionará.");
                return false;
            }

            try {
                const firebaseConfig = JSON.parse(firebaseConfigStr);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                return true;
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                return false;
            }
        }
        
        // --- FIN FIREBASE ---


        document.addEventListener('DOMContentLoaded', async () => {

            // --- 1. LÓGICA DE PESTAÑAS (TABS) ---
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    tabContents.forEach(c => c.classList.remove('active'));
                    document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');
                });
            });

            // --- 2. LÓGICA DE GRÁFICOS (CHART.JS) ---
            let visitsChart, trafficSourceChart;

            // Esta función AHORA inicializa los gráficos VACÍOS
            function initCharts() {
                // Gráfico de Visitas (Línea)
                const ctxVisits = document.getElementById('visitsChart').getContext('2d');
                visitsChart = new Chart(ctxVisits, {
                    type: 'line',
                    data: {
                        labels: [], // Datos vendrán de Firebase
                        datasets: [{
                            label: 'Visitas',
                            data: [], // Datos vendrán de Firebase
                            borderColor: 'var(--primary)',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Visitas en la Última Semana (En Tiempo Real)'
                            }
                        }
                    }
                });

                // Gráfico de Fuentes de Tráfico (Dona)
                const ctxTraffic = document.getElementById('trafficSourceChart').getContext('2d');
                trafficSourceChart = new Chart(ctxTraffic, {
                    type: 'doughnut',
                    data: {
                        labels: ['Directo', 'Orgánico', 'Referido', 'Social'],
                        datasets: [{
                            label: 'Fuentes de Tráfico',
                            data: [], // Datos vendrán de Firebase
                            backgroundColor: [
                                'var(--primary)',
                                'var(--success)',
                                'var(--warning)',
                                'var(--accent)'
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Fuentes de Tráfico (En Tiempo Real)'
                            }
                        }
                    }
                });
            }

            // Inicializar gráficos al cargar
            initCharts();

            // --- 3. LÓGICA DE MAPAS DE CALOR (heatmap.js) ---
            let heatmapInstance = null; // Guardar la instancia del heatmap
            const heatmapContainer = document.getElementById('heatmap-container');
            const heatmapBtn = document.getElementById('generate-heatmap');
            const heatmapPageSelect = document.getElementById('heatmap-page');
            const heatmapImg = document.getElementById('heatmap-screenshot-img');

            // Datos simulados para los mapas de calor
            const heatmapData = {
                homepage: [
                    { x: 150, y: 200, value: 80 }, { x: 160, y: 210, value: 100 }, { x: 155, y: 205, value: 90 }, // Botón "Hero"
                    { x: 500, y: 450, value: 60 }, { x: 490, y: 455, value: 50 }, // "Feature 1"
                    { x: 700, y: 460, value: 40 }, // "Feature 2"
                    { x: 300, y: 800, value: 70 }, { x: 310, y: 805, value: 60 }  // "CTA inferior"
                ],
                pricing: [
                    { x: 300, y: 350, value: 90 }, { x: 310, y: 355, value: 100 }, { x: 295, y: 360, value: 80 }, // "Plan Básico"
                    { x: 600, y: 350, value: 100 }, { x: 610, y: 355, value: 100 }, { x: 595, y: 360, value: 100 }, // "Plan Pro"
                    { x: 605, y: 360, value: 100 }, { x: 600, y: 365, value: 100 },
                    { x: 900, y: 350, value: 50 }, { x: 910, y: 355, value: 40 }  // "Plan Enterprise"
                ]
            };
            
            const pageImages = {
                homepage: 'https://placehold.co/1200x1800/f1f5f9/ccc?text=Simulacion+Homepage',
                pricing: 'https://placehold.co/1200x1800/e0e7ff/999?text=Simulacion+Pagina+Precios'
            };

            function drawHeatmap() {
                const page = heatmapPageSelect.value;
                const data = heatmapData[page] || [];
                
                // Actualizar la imagen de fondo
                heatmapImg.src = pageImages[page];

                // Crear instancia de heatmap si no existe
                if (!heatmapInstance) {
                    heatmapInstance = h337.create({
                        container: heatmapContainer,
                        radius: 50 // Radio de cada punto de calor
                    });
                }
                
                // Escalar los datos al tamaño actual del contenedor
                const containerWidth = heatmapContainer.clientWidth;
                const containerHeight = heatmapContainer.clientHeight;

                const scaledData = data.map(point => ({
                    x: Math.round(point.x / 1200 * containerWidth), // Escalar X
                    y: Math.round(point.y / 1800 * containerHeight), // Escalar Y
                    value: point.value
                }));

                // Establecer los datos en heatmap.js
                heatmapInstance.setData({
                    max: 100, // Intensidad máxima
                    data: scaledData
                });
            }

            heatmapBtn.addEventListener('click', drawHeatmap);
            heatmapPageSelect.addEventListener('change', drawHeatmap);
            // Dibujar el mapa inicial al cargar
            setTimeout(drawHeatmap, 200); // Dar tiempo a que la imagen cargue
            window.addEventListener('resize', drawHeatmap); // Redibujar si cambia tamaño


            // --- 4. LÓGICA DE REPRODUCCIÓN DE SESIÓN (SIMULADO) ---
            const sessionModal = document.getElementById('session-modal');
            const closeSessionModal = document.getElementById('close-session-modal');
            
            document.querySelectorAll('.play-session').forEach(btn => {
                btn.addEventListener('click', () => {
                    sessionModal.style.display = 'flex';
                });
            });

            closeSessionModal.addEventListener('click', () => {
                sessionModal.style.display = 'none';
            });
            
             window.addEventListener('click', (e) => {
                if (e.target == sessionModal) {
                    sessionModal.style.display = 'none';
                }
            });

            // --- 5. LÓGICA DE FIREBASE EN TIEMPO REAL ---
            
            const firebaseReady = await initFirebase();
            if (firebaseReady) {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // Usamos la ruta pública para la demo
                        kpisDocRef = doc(db, 'artifacts', appId, 'public', 'analytics-kpis');
                        setupRealtimeDashboard();
                        setupTrafficSimulator();
                    }
                });
            } else {
                // Mostrar error si Firebase no carga
                document.getElementById('kpi-visits').textContent = "Error";
                document.getElementById('kpi-conversions').textContent = "Error";
                document.getElementById('kpi-bounce').textContent = "Error";
                document.getElementById('kpi-engagement').textContent = "Error";
            }

            function setupRealtimeDashboard() {
                if (!kpisDocRef) return;

                // Escuchar cambios en el documento de KPIs
                onSnapshot(kpisDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        
                        // 1. Actualizar Tarjetas KPI
                        updateKPI('visits', data.totalVisits, data.visitsChange);
                        updateKPI('conversions', data.totalConversions, data.conversionsChange);
                        updateKPI('bounce', `${data.bounceRate}%`, data.bounceChange);
                        updateKPI('engagement', `${data.engagementRate}%`, data.engagementChange);
                        
                        // 2. Actualizar Gráficos
                        visitsChart.data.labels = data.visitsChart.labels;
                        visitsChart.data.datasets[0].data = data.visitsChart.data;
                        visitsChart.update();
                        
                        trafficSourceChart.data.datasets[0].data = data.trafficChart.data;
                        trafficSourceChart.update();

                    } else {
                        console.log("No hay datos de KPIs, creando documento inicial...");
                        // Si no existe el documento, simular tráfico una vez para crearlo
                        simulateTraffic();
                    }
                });
            }
            
            // Función helper para actualizar KPIs y su % de cambio
            function updateKPI(id, value, change) {
                document.getElementById(`kpi-${id}`).textContent = value.toLocaleString ? value.toLocaleString() : value;
                const changeEl = document.getElementById(`kpi-${id}-change`);
                if (change >= 0) {
                    changeEl.innerHTML = `<i class="fas fa-arrow-up"></i> ${change.toFixed(1)}%`;
                    changeEl.className = 'card-change positive';
                } else {
                    changeEl.innerHTML = `<i class="fas fa-arrow-down"></i> ${change.toFixed(1)}%`;
                    changeEl.className = 'card-change negative';
                }
            }

            // --- 6. SIMULADOR DE TRÁFICO ---
            function setupTrafficSimulator() {
                document.getElementById('simulate-traffic-btn').addEventListener('click', simulateTraffic);
            }

            async function simulateTraffic() {
                if (!kpisDocRef) return;

                console.log("Simulando nuevos datos de tráfico...");

                // Generar datos aleatorios
                const newData = {
                    totalVisits: Math.floor(Math.random() * 5000) + 15000,
                    visitsChange: (Math.random() * 10) - 3,
                    totalConversions: Math.floor(Math.random() * 200) + 700,
                    conversionsChange: (Math.random() * 5) - 2,
                    bounceRate: (Math.random() * 10) + 40,
                    bounceChange: (Math.random() * 4) - 2,
                    engagementRate: (Math.random() * 10) + 60,
                    engagementChange: (Math.random() * 5) - 1,
                    visitsChart: {
                        labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
                        data: [...Array(7)].map(() => Math.floor(Math.random() * 5000) + 1000)
                    },
                    trafficChart: {
                        data: [...Array(4)].map(() => Math.floor(Math.random() * 50) + 10)
                    }
                };
                
                // Escribir los nuevos datos en Firestore
                // Esto disparará automáticamente el listener 'onSnapshot'
                try {
                    await setDoc(kpisDocRef, newData);
                    console.log("Datos simulados enviados a Firestore.");
                } catch (error) {
                    console.error("Error al simular tráfico: ", error);
                }
            }

        });
    </script>
</body>
</html>
