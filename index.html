<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DataConecta — Shell</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">

  <!-- Small inline favicon data URI to avoid 404 requests for /favicon.ico on GitHub Pages -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16'%3E%3Crect width='100%25' height='100%25' fill='%234f46e5' rx='3'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='10' fill='%23fff'%3EDC%3C/text%3E%3C/svg%3E">

  <style>
    :root{ --bg:#0f1724; --card:#0b1220; --accent:#4f46e5; --muted:#9aa4b2; font-family:Inter,system-ui,Arial, sans-serif; color:#e6eef6; }
    html,body{ height:100%; margin:0; background:linear-gradient(180deg,#061226 0%, #07182b 100%); }
    .shell{ display:flex; height:100vh; gap:24px; padding:36px; box-sizing:border-box; align-items:center; justify-content:center; }
    .panel{ background:rgba(255,255,255,0.03); border-radius:14px; padding:28px; width:100%; max-width:1100px; box-shadow: 0 10px 30px rgba(2,6,23,0.6); }
    .hero{ display:flex; gap:24px; align-items:center; }
    .hero-left{ flex:1; }
    .title{ font-size:28px; margin:0 0 8px 0; color:#fff; }
    .subtitle{ margin:0 0 18px 0; color:var(--muted); }
    .modules{ display:flex; gap:12px; flex-wrap:wrap; }
    .module-card{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); padding:16px; border-radius:10px; min-width:220px; cursor:pointer; transition:transform .12s; }
    .module-card:hover{ transform:translateY(-6px); box-shadow: 0 8px 30px rgba(0,0,0,0.5); }
    .module-card h3{ margin:0 0 6px 0; color:#fff; }
    .module-card p{ margin:0; color:var(--muted); font-size:13px; }
    #app-root{ margin-top:24px; }
    nav.shell-nav{ display:flex; gap:8px; justify-content:center; margin-top:18px; }
    .btn{ background:var(--accent); color:#fff; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; }
    footer{ text-align:center; color:var(--muted); margin-top:18px; font-size:13px; }
    /* Ensure module container scrolls if needed */
    #app-root { margin-top: 18px; max-height: 60vh; overflow:auto; }
  </style>
</head>
<body>
  <div class="shell">
    <div class="panel">
      <div class="hero">
        <div class="hero-left">
          <h1 class="title">DataConecta</h1>
          <p class="subtitle">CRM · UX Editor · Analítica — Plataforma integrada. Pulsa un módulo para abrirlo.</p>

          <div class="modules" role="navigation" aria-label="Módulos">
            <div class="module-card" id="open-crm" role="button" tabindex="0" aria-pressed="false">
              <h3><i class="fas fa-address-book"></i> CRM & Marketing</h3>
              <p>Gestiona contactos, empresas, deals, campañas y comunicaciones.</p>
            </div>

            <div class="module-card" id="open-editor" role="button" tabindex="0" aria-pressed="false">
              <h3><i class="fas fa-pencil-ruler"></i> Editor UX/UI</h3>
              <p>Diseña pantallas, componentes y prototipos con artboards y export.</p>
            </div>

            <div class="module-card" id="open-analytics" role="button" tabindex="0" aria-pressed="false">
              <h3><i class="fas fa-chart-line"></i> Analítica</h3>
              <p>Recolección, informes, predicción, embudos y conectores (BigQuery, Ads).</p>
            </div>
          </div>

          <nav class="shell-nav" aria-label="Acciones rápidas">
            <button class="btn" id="btn-open-crm">Abrir CRM</button>
            <button class="btn" id="btn-open-editor-shell">Abrir Editor</button>
            <button class="btn" id="btn-open-analytics-shell">Abrir Analítica</button>
          </nav>

        </div>
        <div class="hero-right" style="width:360px;">
          <div style="background:rgba(255,255,255,0.02); padding:16px; border-radius:10px;">
            <strong>Estado</strong>
            <p style="color:var(--muted); margin-top:8px;">Módulos cargados dinámicamente: CRM, Editor UX/UI y Analítica. Cada módulo es independiente y puede exponer init() / destroy().</p>
          </div>
        </div>
      </div>

      <div id="app-root" aria-live="polite"></div>

      <footer>DataConecta — Shell (mascara) — dsd228</footer>
    </div>
  </div>

  <script>
    // Module loader: lazy loads HTML fragment + CSS + JS and calls moduleAPI.init(params)
    window.__currentModule = null;

    async function loadModule({ name, html, js, css, params = {} }) {
      const container = document.getElementById('app-root');
      if (!container) throw new Error('No app root');

      // try to destroy previous module cleanly
      if (window.__currentModule && window.__currentModule.apiName) {
        try {
          const prevApi = window[window.__currentModule.apiName];
          if (prevApi && typeof prevApi.destroy === 'function') {
            await prevApi.destroy();
          }
        } catch (e) { console.warn('previous destroy error', e); }
        container.innerHTML = '';
      }

      // load HTML
      const resp = await fetch(html, { cache: 'no-cache' });
      if (!resp.ok) throw new Error('Failed to load module HTML: ' + html + ' (status ' + resp.status + ')');
      const htmlText = await resp.text();
      container.innerHTML = htmlText;

      // load css if provided and not yet loaded
      if (css && !document.querySelector(`link[data-module="${name}"]`)) {
        const link = document.createElement('link');
        link.rel = 'stylesheet'; link.href = css; link.setAttribute('data-module', name);
        document.head.appendChild(link);
      }

      // load js (if not already loaded)
      if (js && !document.querySelector(`script[data-module="${name}"]`)) {
        await new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = js; s.async = true; s.setAttribute('data-module', name);
          s.onload = () => resolve();
          s.onerror = (e) => reject(new Error('Failed to load module script: ' + js + ' (' + (e && e.message) + ')'));
          document.body.appendChild(s);
        });
      }

      // set current
      const apiName = name + 'API';
      window.__currentModule = { name, apiName };

      // call init if available
      if (window[apiName] && typeof window[apiName].init === 'function') {
        try {
          await window[apiName].init(params);
        } catch (err) {
          // bubble up
          throw err;
        }
      } else {
        console.warn(`${apiName}.init not found`);
      }
    }

    // wrapper that shows friendly error UI
    async function safeLoadModule(opts) {
      try {
        await loadModule(opts);
      } catch (err) {
        console.error('loadModule failed', err);
        const container = document.getElementById('app-root');
        container.innerHTML = '<div style="padding:18px;background:#fff;border-radius:8px;color:#111">Error al cargar el módulo: ' + (err.message || err) + '</div>';
        alert('No se pudo cargar el módulo. Revisa la consola Network para ver rutas 404 y corrígelas.');
      }
    }

    // Utility: check resource existence (HEAD) with graceful fallback to GET for some hosts
    async function exists(url) {
      try {
        const r = await fetch(url, { method: 'HEAD' });
        if (r.ok) return true;
        // some static hosts block HEAD -> try GET lightweight
        const r2 = await fetch(url, { method: 'GET' });
        return r2.ok;
      } catch (e) {
        return false;
      }
    }

    // Open editor: prefer module injection, fallback to standalone editor/index.html
    async function openEditorModuleOrStandalone() {
      const moduleHtml = 'modules/editor.html';
      const moduleJs = 'modules/editor.js';
      const moduleCss = 'modules/editor.css';
      const standalone = 'editor/index.html';

      // prefer module (embedded)
      if (await exists(moduleHtml) && await exists(moduleJs)) {
        return safeLoadModule({ name: 'editor', html: moduleHtml, js: moduleJs, css: moduleCss });
      }

      // fallback to standalone page
      if (await exists(standalone)) {
        window.open(standalone, '_blank');
        return;
      }

      // nothing found: actionable message
      alert('Editor no encontrado en el repositorio.\n\nAgrega:\n- modules/editor.html + modules/editor.js + modules/editor.css  (para cargar en la máscara) \n- o editor/index.html + editor/editor.js + editor/styles.css (standalone)\n\nPuedo generar esos archivos y sus vínculos si quieres.');
    }

    // bind UI triggers using safe loader; editor button uses robust openEditorModuleOrStandalone
    document.getElementById('open-crm')?.addEventListener('click', () => safeLoadModule({ name:'crm', html:'modules/crm.html', js:'modules/crm.js', css:'modules/crm.css' }));
    document.getElementById('open-editor')?.addEventListener('click', () => openEditorModuleOrStandalone());
    document.getElementById('open-analytics')?.addEventListener('click', () => safeLoadModule({ name:'analytics', html:'modules/analytics.html', js:'modules/analytics.js', css:'modules/analytics.css' }));

    document.getElementById('btn-open-crm')?.addEventListener('click', () => document.getElementById('open-crm').click());
    document.getElementById('btn-open-editor-shell')?.addEventListener('click', () => document.getElementById('open-editor').click());
    document.getElementById('btn-open-analytics-shell')?.addEventListener('click', () => document.getElementById('open-analytics').click());
  </script>
</body>
</html>
